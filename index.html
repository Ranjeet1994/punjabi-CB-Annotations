<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cyberbullying Annotation Tool</title>
<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ccc; padding: 8px; }
th { background: #f4f4f4; position: sticky; top: 0; }
select { width: 100%; }
tr.completed { background: #e6ffe6; }
button { padding: 4px 8px; }
</style>
</head>
<body>

<h2>Cyberbullying Annotation Tool (Final Labels)</h2>

<input type="file" id="fileInput" accept=".xlsx,.xls" />
<p>Total comments: <span id="totalCount">0</span></p>
<p>Page: <span id="currentPage">1</span> / <span id="totalPages">1</span></p>

<table id="dataTable">
<thead>
<tr>
<th>Sr. No.</th>
<th>Comment (Gurmukhi)</th>
<th>Subtask 1</th>
<th>Subtask 2</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button id="prevBtn">Previous</button>
<button id="nextBtn">Next</button>
<button id="downloadBtn">Download CSV</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const tbody = document.querySelector("#dataTable tbody");
let comments = [];
let annotations = {};
let currentPage = 1;
const pageSize = 100;
let totalPages = 1;

/* Load Excel */
document.getElementById("fileInput").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    let col = -1, start = 0;
    for (let i = 0; i < rows.length; i++) {
      if (rows[i].some(c => String(c).toLowerCase().includes("gurmukhi"))) {
        col = rows[i].findIndex(c => String(c).toLowerCase().includes("gurmukhi"));
        start = i + 1;
        break;
      }
    }

    comments = rows.slice(start).map(r => r[col]).filter(Boolean);
    totalPages = Math.ceil(comments.length / pageSize);
    document.getElementById("totalCount").innerText = comments.length;
    document.getElementById("totalPages").innerText = totalPages;
    render();
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

/* Render */
function render() {
  tbody.innerHTML = "";
  const start = (currentPage - 1) * pageSize;
  const end = Math.min(start + pageSize, comments.length);

  for (let i = start; i < end; i++) {
    const tr = document.createElement("tr");
    const a = annotations[i] || {};
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${comments[i]}</td>
      <td>
        <select class="sub1">
          <option value="">--Select--</option>
          <option value="CB">CB</option>
          <option value="NOT_CB">NOT_CB</option>
        </select>
      </td>
      <td>
        <select class="sub2"></select>
      </td>
      <td><button class="unlockBtn" style="display:none">Unlock</button></td>
    `;

    const sub1 = tr.querySelector(".sub1");
    const sub2 = tr.querySelector(".sub2");
    const unlockBtn = tr.querySelector(".unlockBtn");

    function populateSub2(mode) {
      sub2.innerHTML = `<option value="">--Select--</option>`;
      if (mode === "CB") {
        ["Religion","Gender","Other"].forEach(v =>
          sub2.innerHTML += `<option value="${v}">${v}</option>`);
      } else {
        ["Religion","NCB","Gender","Other"].forEach(v =>
          sub2.innerHTML += `<option value="${v}">${v}</option>`);
      }
    }

    populateSub2("");

    if (a.sub1) sub1.value = a.sub1;
    if (a.sub1 === "CB") populateSub2("CB");
    if (a.sub2) sub2.value = a.sub2;

    function lockRow() {
      if (sub1.value && sub2.value) {
        sub1.disabled = true;
        sub2.disabled = true;
        unlockBtn.style.display = "inline";
        tr.classList.add("completed");
      }
    }

    unlockBtn.onclick = () => {
      sub1.disabled = false;
      sub2.disabled = false;
      unlockBtn.style.display = "none";
      tr.classList.remove("completed");
    };

    sub1.onchange = () => {
      if (sub1.value === "NOT_CB") {
        populateSub2("");
        sub2.value = "NCB";
        sub2.disabled = true;
      } else if (sub1.value === "CB") {
        populateSub2("CB");
        sub2.disabled = false;
        sub2.value = "";
      } else {
        populateSub2("");
        sub2.disabled = false;
        sub2.value = "";
      }
      annotations[i] = { sub1: sub1.value, sub2: sub2.value };
      lockRow();
    };

    sub2.onchange = () => {
      annotations[i] = { sub1: sub1.value, sub2: sub2.value };
      lockRow();
    };

    lockRow();
    tbody.appendChild(tr);
  }
  document.getElementById("currentPage").innerText = currentPage;
}

/* Pagination */
document.getElementById("prevBtn").onclick = () => { if (currentPage > 1) { currentPage--; render(); }};
document.getElementById("nextBtn").onclick = () => { if (currentPage < totalPages) { currentPage++; render(); }};

/* Download CSV */
document.getElementById("downloadBtn").onclick = () => {
  let rows = [["Sr No","Comment","Subtask1","Subtask2"]];
  comments.forEach((c,i)=>{
    const a = annotations[i] || {};
    rows.push([i+1,c,a.sub1||"",a.sub2||""]);
  });
  const csv = rows.map(r=>r.map(x=>`"${x}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "annotations.csv";
  a.click();
};
</script>
</body>
</html>
